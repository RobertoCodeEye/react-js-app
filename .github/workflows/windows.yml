name: Windows_IRIS_Scan

on: [push, pull_request]

jobs:
    scan:
        runs-on: windows-latest

        steps:
        - name: Check out repository
          uses: actions/checkout@v2

        # - name: Install dependencies
        #   shell: powershell
        #   run: npm install
          
        - name: Create Settings File
          shell: powershell
          run: |
            $jsonContent = $env:IRIS_SETTINGS
            # $jsonContent | Out-File -FilePath "iris.settings.json" -Encoding utf8
            echo DEBUGGING="true" > .env
            #cat ./iris.settings.json
            cat ./.env
            dir
          env: 
            IRIS_SETTINGS: ${{ secrets.IRIS_SETTINGS }}
          
        - name: Download IRIS Scanner CLI 
          shell: powershell
          run: Invoke-WebRequest -Uri "https://iris.codeeyesolutions.com/assets/onprem/win/v1/iris-scanner-cli-debug.exe" -OutFile "iris-scanner-cli.exe"

        - name: Run Scan 
          shell: powershell
          run: |
            $jsonContent = $env:IRIS_SETTINGS
            $jsonContent | Out-File -FilePath "iris.settings.json" -Encoding utf8
            $commitId = "${{ github.sha }}"
            $shortCommitId = "PR-"+$commitId.Substring(0, 8)
            $currentDirectory = (Get-Location).Path
            .\iris-scanner-cli.exe -s $currentDirectory -r $shortCommitId
          env: 
            IRIS_SETTINGS: ${{ secrets.IRIS_SETTINGS }}
